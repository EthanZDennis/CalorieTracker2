<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>CalorieHUD 2.0</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <style>
    :root { --primary: #6366f1; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; }
    body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
    .tabs { display: flex; gap: 8px; background: #e0e7ff; padding: 4px; border-radius: 12px; margin-bottom: 20px; }
    .tab { flex: 1; text-align: center; padding: 10px; border-radius: 10px; font-weight: 700; color: #6366f1; cursor: pointer; }
    .tab.active { background: white; color: #1e1b4b; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .progress-card { background: var(--card); padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
    .card { background: var(--card); padding: 15px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .card-label { font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; }
    .card-value { font-size: 24px; font-weight: 800; }
    .btn { background: var(--primary); color: white; width: 100%; padding: 15px; border-radius: 14px; font-weight: 700; border: none; cursor: pointer; }
    .chart-wrapper { background: white; padding: 20px; border-radius: 24px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
    .scroll-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .wide-chart-body { height: 280px; width: 1200px; position: relative; }
    .history-item { display: flex; justify-content: space-between; padding: 14px 15px; border-bottom: 1px solid #f1f5f9; align-items: center; }
    .hidden { display: none; }
    input, select { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 12px; margin-bottom: 10px; box-sizing: border-box; }
  </style>
</head>
<body onload="init()">
  <div class="tabs">
    <div id="tabHusband" class="tab active" onclick="setUser('husband')">üá∫üá∏ Husband</div>
    <div id="tabWife" class="tab" onclick="setUser('wife')">üáØüáµ Wife</div>
  </div>

  <div class="progress-card">
    <div class="card-label">Consumed Today üçΩÔ∏è</div>
    <div class="card-value" style="color: var(--primary);" id="consumedDisplay">0</div>
    <div style="margin-top: 15px;">
      <div style="display: flex; justify-content: space-between; font-size: 13px; font-weight: 700; color: #64748b; margin-bottom: 8px;">
        <span id="remainingDisplay">4000 kcal left</span>
        <span id="percentDisplay">0%</span>
      </div>
      <div style="background: #f1f5f9; height: 14px; border-radius: 10px; overflow: hidden;">
        <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #6366f1, #818cf8); border-radius: 10px; transition: width 0.8s ease;"></div>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="card"><div class="card-label">Goal üéØ</div><div id="goalDisplay" class="card-value">4000</div></div>
    <div class="card" onclick="toggleWeight()"><div class="card-label">Weight ‚úèÔ∏è</div><div class="card-value"><span id="weightDisplay">--</span> lbs</div></div>
  </div>

  <div style="display:flex; gap:10px; margin-top:20px; margin-bottom:20px;">
    <button class="btn" style="background:#fff; color:var(--primary); border:1px solid var(--primary);" id="photoBtn" onclick="document.getElementById('cameraInput').click()">üì∏ Photo</button>
    <input type="file" id="cameraInput" accept="image/*" style="display:none" onchange="handlePhoto(this)">
    <button class="btn" onclick="setMode('manual')">‚úçÔ∏è Manual</button>
  </div>

  <div id="modeManual" class="card hidden">
    <input type="date" id="mDate">
    <div class="grid"><input type="number" id="mCals" placeholder="Cals"><input type="number" id="mProt" placeholder="Prot"></div>
    <button class="btn" id="logBtn" onclick="submitManual()">Log Meal</button>
  </div>

  <div class="chart-wrapper">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
      <span class="card-label">Daily Weight</span>
      <select id="viewSelector" onchange="loadStats()" style="width:auto; margin:0; padding:5px; font-size:12px;">
        <option value="rolling">Last 30 Days</option>
        <option value="0">January</option>
      </select>
    </div>
    <div class="scroll-wrapper" id="scrollContainer"><div class="wide-chart-body"><canvas id="calChart"></canvas></div></div>
  </div>

  <div id="historyList"></div>

  <script>
    let currentUser = 'husband';
    let weightChartInstance = null;
    let calChartInstance = null;
    const GOALS = { husband: 4000, wife: 2000 };

    function init() { setUser('husband'); }

    function setUser(user) {
      currentUser = user;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById(user === 'husband' ? 'tabHusband' : 'tabWife').classList.add('active');
      document.getElementById('goalDisplay').innerText = GOALS[user];
      const tz = user === 'husband' ? 'Pacific/Honolulu' : 'Asia/Tokyo';
      document.getElementById('mDate').value = new Date().toLocaleDateString("en-CA", { timeZone: tz });
      loadStats();
    }

    async function loadStats() {
      const res = await fetch(`/api/stats?user=${currentUser}`);
      const data = await res.json();
      const consumed = data.totalCals;
      const goal = GOALS[currentUser];
      const remaining = Math.max(0, goal - consumed);
      const pct = Math.min(100, Math.round((consumed / goal) * 100));

      document.getElementById('consumedDisplay').innerText = consumed;
      document.getElementById('remainingDisplay').innerText = remaining + " kcal left";
      document.getElementById('percentDisplay').innerText = pct + "%";
      document.getElementById('progressBar').style.width = pct + "%";
      document.getElementById('weightDisplay').innerText = data.lastWeight || '--';
      
      renderCharts(data);
      renderHistory(data.recentLogs);
    }

    // Shrinking logic integrated into handlePhoto
    async function handlePhoto(input) {
      if (!input.files || !input.files[0]) return;
      const btn = document.getElementById('photoBtn');
      const originalText = btn.innerText;
      btn.innerText = "‚åõ Shrinking...";

      const file = input.files[0];
      const img = new Image();
      img.src = URL.createObjectURL(file);

      img.onload = () => {
        const canvas = document.createElement('canvas');
        const MAX_WIDTH = 1200;
        const scale = MAX_WIDTH / img.width;
        canvas.width = MAX_WIDTH;
        canvas.height = img.height * scale;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        canvas.toBlob(async (blob) => {
          btn.innerText = "‚åõ Analyzing...";
          const formData = new FormData();
          formData.append('photo', blob, 'shrunk.jpg');
          formData.append('user', currentUser);
          try {
            const res = await fetch('/api/log/photo', { method: 'POST', body: formData });
            const data = await res.json();
            alert(`Logged: ${data.item} (${data.calories} kcal)`);
            loadStats();
          } catch (err) { alert("Photo failed."); } 
          finally { btn.innerText = originalText; }
        }, 'image/jpeg', 0.7);
      };
    }

    function renderCharts(data) {
      const labels = []; const calValues = []; const goalLine = [];
      const tz = currentUser === 'husband' ? 'Pacific/Honolulu' : 'Asia/Tokyo';
      let start = new Date(new Date().toLocaleString("en-US", {timeZone: tz}));
      start.setDate(start.getDate() - 29);

      for(let i=0; i < 30; i++) {
        const d = new Date(start); d.setDate(d.getDate() + i);
        const isoDate = d.toLocaleDateString("en-CA");
        const displayLabel = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        labels.push(displayLabel);
        goalLine.push(GOALS[currentUser]);
        let daySum = 0;
        data.chartData.labels.forEach((l, idx) => {
          if (l === isoDate || new Date(l).toLocaleDateString("en-CA") === isoDate) daySum += data.chartData.values[idx];
        });
        calValues.push(daySum);
      }

      const ctxCal = document.getElementById('calChart').getContext('2d');
      if(calChartInstance) calChartInstance.destroy();
      calChartInstance = new Chart(ctxCal, {
        type: 'bar',
        data: { labels, datasets: [{ type: 'line', data: goalLine, borderColor: '#ef4444', borderDash:[5,5], pointRadius:0 }, { data: calValues, backgroundColor: '#6366f1', borderRadius: 6, barThickness: 35 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
      });
      document.getElementById('scrollContainer').scrollLeft = 9999;
    }

    function renderHistory(logs) {
      const groups = {};
      logs.forEach(l => {
        const d = new Date(l.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        if(!groups[d]) groups[d] = { total: 0, items: [] };
        groups[d].items.push(l); groups[d].total += parseInt(l.calories || 0);
      });
      document.getElementById('historyList').innerHTML = '<div class="card-label" style="margin: 20px 0 10px 5px;">RECENT HISTORY üìÖ</div>' + 
        Object.keys(groups).sort((a,b)=>new Date(b)-new Date(a)).map(k => `
        <div style="margin-bottom:20px; border:1px solid #f1f5f9; border-radius:16px; overflow:hidden; background:white;">
          <div style="font-size:14px; font-weight:700; background:#f8fafc; padding:10px 15px; display:flex; justify-content:space-between;"><span>${k}</span><span style="color:var(--primary)">${groups[k].total} cals</span></div>
          ${groups[k].items.map(i => `<div class="history-item"><div><b>${i.item}</b><br><small style="color:#64748b;">${i.category || 'Meal'}</small></div><div><b>${i.calories}</b> <span onclick="deleteLog('${i.id}')">üóëÔ∏è</span></div></div>`).join('')}
        </div>
      `).join('');
    }

    async function submitManual() {
      const body = { user: currentUser, item: "Manual Log", calories: document.getElementById('mCals').value, protein: document.getElementById('mProt').value, date: document.getElementById('mDate').value, category: "Manual" };
      await fetch("/api/log/manual", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
      document.getElementById('mCals').value = ""; document.getElementById('mProt').value = "";
      document.getElementById('modeManual').classList.add('hidden');
      loadStats();
    }

    async function deleteLog(id) { if(confirm("Delete?")) { await fetch(`/api/log/${id}`, { method: 'DELETE', body: JSON.stringify({ user: currentUser }), headers: {'Content-Type':'application/json'} }); loadStats(); } }
    function setMode(m) { document.getElementById('modeManual').classList.toggle('hidden', m!=='manual'); }
    function toggleWeight() { document.getElementById('modeManual').classList.remove('hidden'); document.getElementById('mCals').placeholder="Weight"; }
  </script>
</body>
</html>
