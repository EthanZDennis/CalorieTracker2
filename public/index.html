<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>CalorieHUD</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  
  <style>
    :root { --primary: #6366f1; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --danger: #ef4444; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; -webkit-tap-highlight-color: transparent; }
    
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .brand { font-size: 24px; font-weight: 800; color: #1e1b4b; }
    
    /* TABS */
    .tabs { display: flex; gap: 8px; background: #e0e7ff; padding: 4px; border-radius: 12px; margin-bottom: 20px; }
    .tab { flex: 1; text-align: center; padding: 10px; border-radius: 10px; font-weight: 600; color: #6366f1; cursor: pointer; transition: all 0.2s; }
    .tab.active { background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); color: #1e1b4b; }

    /* GRID & CARDS */
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
    .card { background: var(--card); padding: 15px; border-radius: 20px; box-shadow: 0 4px 15px -2px rgba(0,0,0,0.05); }
    .card-label { font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; margin-bottom: 5px; }
    .card-value { font-size: 24px; font-weight: 800; }
    .unit { font-size: 14px; color: #94a3b8; font-weight: 600; }
    
    /* PROGRESS BAR CARD */
    .progress-card { background: var(--card); padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px -2px rgba(0,0,0,0.05); margin-bottom: 20px; }

    /* INPUT BUTTONS */
    .mode-switch { display: flex; gap: 10px; margin-bottom: 20px; }
    .mode-btn { flex: 1; padding: 12px; border-radius: 14px; background: #fff; text-align: center; font-weight: 700; font-size: 15px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.03); border: 2px solid transparent; transition: all 0.2s; }
    .mode-btn.active { border-color: var(--primary); color: var(--primary); background: #eef2ff; }

    input, select { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 12px; font-size: 16px; box-sizing: border-box; margin-bottom: 10px; }
    .btn { background: var(--primary); color: white; width: 100%; padding: 15px; border-radius: 14px; font-size: 16px; font-weight: 700; border: none; cursor: pointer; }

    /* CHARTS */
    .chart-wrapper { background: white; padding: 20px; border-radius: 24px; margin-bottom: 20px; box-shadow: 0 4px 20px -2px rgba(0,0,0,0.05); }
    
    .scroll-wrapper {
      overflow-x: auto;
      padding-bottom: 10px;
      -webkit-overflow-scrolling: touch; 
    }
    .wide-chart-body { height: 280px; width: 1500px; position: relative; }
    .weight-chart-body { height: 200px; position: relative; }

    /* HISTORY LIST */
    .history-section { margin-top: 30px; }
    .day-group { margin-bottom: 20px; border: 1px solid #f1f5f9; border-radius: 16px; overflow: hidden; background: white; }
    .day-header { 
      font-size: 14px; font-weight: 700; color: #475569; 
      display: flex; justify-content: space-between; align-items: center;
      background: #f8fafc; padding: 10px 15px; 
    }
    .day-total { font-size: 12px; background: white; padding: 4px 8px; border-radius: 6px; color: var(--primary); font-weight: 700; border: 1px solid #e2e8f0; }
    .day-items { padding: 0 15px; }
    
    .history-item { display: flex; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid #f1f5f9; align-items: center; }
    .history-item:last-child { border-bottom: none; }
    .history-left { display: flex; flex-direction: column; }
    .history-name { font-weight: 600; font-size: 15px; color: #1e293b; }
    .history-meta { font-size: 12px; color: #94a3b8; margin-top: 2px; }
    .history-right { display: flex; align-items: center; gap: 12px; }
    .cals-badge { font-weight: 700; color: #1e293b; font-size: 15px; }
    .delete-btn { cursor: pointer; font-size: 18px; opacity: 0.6; }
    .delete-btn:hover { opacity: 1; }
    .hidden { display: none; }
  </style>
</head>
<body onload="init()">

  <div class="header"><div class="brand">CalorieHUD 2.0</div></div>

  <div class="tabs">
    <div id="tabHusband" class="tab active" onclick="setUser('husband')">üá∫üá∏ Husband</div>
    <div id="tabWife" class="tab" onclick="setUser('wife')">üáØüáµ Wife</div>
  </div>

  <div class="progress-card">
    <div class="card-label">Consumed Today üçΩÔ∏è</div>
    <div class="card-value" style="color: var(--primary); margin-bottom: 10px;" id="consumedDisplay">0</div>
    <div style="background:#f1f5f9; height:10px; border-radius:5px; overflow:hidden;">
      <div id="progressBar" style="width:0%; height:100%; background:var(--primary); transition: width 0.5s;"></div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="card-label">Daily Goal üéØ</div>
      <div class="card-value" id="goalDisplay">4000</div>
    </div>
    <div class="card" onclick="toggleWeight()">
      <div class="card-label">Weight ‚úèÔ∏è</div>
      <div class="card-value"><span id="weightDisplay">--</span> <span class="unit">lbs</span></div>
    </div>
  </div>

  <div id="weightInputArea" class="card hidden" style="margin-bottom: 20px;">
    <div class="card-label" style="margin-bottom:10px">Log Weight</div>
    <input type="date" id="weightDate" style="margin-bottom: 10px;">
    <input type="number" id="newWeight" placeholder="Weight (lbs)" style="margin-bottom: 10px;">
    <button class="btn" onclick="submitWeight()">Save Weight</button>
  </div>

  <div class="mode-switch">
    <div class="mode-btn active" onclick="setMode('photo')" id="btnModePhoto">üì∏ Photo</div>
    <div class="mode-btn" onclick="setMode('manual')" id="btnModeManual">‚úçÔ∏è Manual</div>
  </div>

  <div id="modePhoto">
    <div class="card" style="text-align: center; padding: 30px; margin-bottom: 20px;">
      <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="uploadPhoto()">
      <button class="btn" id="photoBtn" onclick="document.getElementById('fileInput').click()">Take Photo</button>
      <div id="status" style="margin-top:15px; font-size:14px; font-weight:600; color:#64748b">AI Ready</div>
    </div>
  </div>

  <div id="modeManual" class="hidden">
    <div class="card" style="margin-bottom: 20px;">
      <div class="card-label">Log Past Meal?</div>
      <input type="date" id="mDate" style="margin-bottom: 15px;">
      <select id="mCategory">
        <option>Breakfast</option><option>Lunch</option><option>Dinner</option><option>Snack</option><option>Protein Shake</option>
      </select>
      <div class="grid" style="margin-bottom:0">
        <input type="number" id="mCals" placeholder="Calories (Optional)">
        <input type="number" id="mProt" placeholder="Protein (Optional)">
      </div>
      <button class="btn" style="margin-top:15px;" onclick="submitManual()">Log Meal</button>
    </div>
  </div>

  <div class="chart-wrapper">
    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
        <span class="card-label">Last 30 Days üî•</span>
        <span style="font-size:12px; color:#94a3b8">Swipe ‚ÜîÔ∏è</span>
    </div>
    <div class="scroll-wrapper" id="scrollContainer">
      <div class="wide-chart-body">
        <canvas id="calChart"></canvas>
      </div>
    </div>
  </div>

  <div class="chart-wrapper">
    <div class="card-label" style="margin-bottom:15px">Weight Trend üìâ</div>
    <div class="weight-chart-body">
      <canvas id="weightChart"></canvas>
    </div>
  </div>

  <div class="history-section">
    <div class="card-label" style="margin-bottom: 10px;">Recent History üìÖ</div>
    <div id="historyList"></div>
  </div>

  <script>
    let currentUser = 'husband';
    let weightChartInstance = null;
    let calChartInstance = null;
    const GOALS = { husband: 4000, wife: 2000 };

    function init() { 
      setUser('husband'); 
    }

    function setUser(user) {
      currentUser = user;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById(user === 'husband' ? 'tabHusband' : 'tabWife').classList.add('active');
      document.getElementById('goalDisplay').innerText = GOALS[user];
      
      const tz = user === 'husband' ? 'Pacific/Honolulu' : 'Asia/Tokyo';
      updateDatePicker(tz);
      loadStats();
    }

    function getTodayForUser() {
      const tz = currentUser === 'husband' ? 'Pacific/Honolulu' : 'Asia/Tokyo';
      return new Date().toLocaleDateString("en-CA", { timeZone: tz });
    }

    // Updates BOTH date pickers (Food and Weight) to the correct timezone
    function updateDatePicker(timeZone) {
      try {
        const dateStr = new Date().toLocaleDateString("en-CA", { timeZone: timeZone });
        if(document.getElementById('mDate')) document.getElementById('mDate').value = dateStr;
        if(document.getElementById('weightDate')) document.getElementById('weightDate').value = dateStr;
      } catch (e) { 
        const today = new Date().toISOString().split('T')[0];
        if(document.getElementById('mDate')) document.getElementById('mDate').value = today;
        if(document.getElementById('weightDate')) document.getElementById('weightDate').value = today;
      }
    }

    function setMode(mode) {
      document.getElementById('modePhoto').classList.toggle('hidden', mode !== 'photo');
      document.getElementById('modeManual').classList.toggle('hidden', mode !== 'manual');
      document.getElementById('btnModePhoto').classList.toggle('active', mode === 'photo');
      document.getElementById('btnModeManual').classList.toggle('active', mode === 'manual');
    }

    function toggleWeight() { document.getElementById('weightInputArea').classList.toggle('hidden'); }

    async function loadStats() {
      try {
        const res = await fetch(`/api/stats?user=${currentUser}`);
        const data = await res.json();
        
        document.getElementById('consumedDisplay').innerText = data.totalCals;
        document.getElementById('weightDisplay').innerText = data.lastWeight || '--';
        
        const goal = currentUser === 'husband' ? 4000 : 2000;
        const pct = Math.min(100, (data.totalCals / goal) * 100);
        document.getElementById('progressBar').style.width = pct + '%';

        renderGroupedHistory(data.recentLogs);

        if (typeof Chart !== 'undefined') {
          renderWeightChart(data.weightHistory || []);
          renderCalorieChart(data.chartData);
        }
      } catch (e) { console.error("Load Stats Error:", e); }
    }

    function renderGroupedHistory(logs) {
        const list = document.getElementById('historyList');
        if (!logs || logs.length === 0) {
            list.innerHTML = '<div style="padding:20px; text-align:center; color:#94a3b8">No history found.</div>';
            return;
        }

        const groups = {};
        logs.forEach(l => {
            const d = new Date(l.timestamp);
            const dateKey = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            if (!groups[dateKey]) { groups[dateKey] = { dateObj: d, total: 0, items: [] }; }
            groups[dateKey].items.push(l);
            groups[dateKey].total += parseInt(l.calories || 0);
        });

        const sortedKeys = Object.keys(groups).sort((a, b) => groups[b].dateObj - groups[a].dateObj);

        let html = '';
        sortedKeys.forEach(key => {
            const group = groups[key];
            html += `
            <div class="day-group">
                <div class="day-header">
                    <span>${key}</span>
                    <span class="day-total">${group.total} cals</span>
                </div>
                <div class="day-items">`;
            group.items.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            group.items.forEach(l => {
                html += `
                <div class="history-item">
                    <div class="history-left">
                        <span class="history-name">${l.item}</span>
                        <span class="history-meta">${l.category}</span>
                    </div>
                    <div class="history-right">
                        <div class="cals-badge">${l.calories}</div>
                        <div class="delete-btn" onclick="deleteLog('${l.id}')">üóëÔ∏è</div>
                    </div>
                </div>`;
            });
            html += `</div></div>`;
        });
        list.innerHTML = html;
    }

    function renderCalorieChart(calsData) {
      const ctx = document.getElementById('calChart').getContext('2d');
      if (calChartInstance) calChartInstance.destroy();

      const labels = [];
      const values = [];
      const goalValue = GOALS[currentUser];
      const goalLine = [];

      for (let i = 29; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const label = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        labels.push(label);
        
        const index = calsData.labels.indexOf(label);
        values.push(index > -1 ? calsData.values[index] : 0);
        goalLine.push(goalValue);
      }

      calChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              type: 'line',
              label: 'Goal',
              data: goalLine,
              borderColor: '#ef4444', 
              borderWidth: 2,
              borderDash: [6, 4], 
              pointRadius: 0,
              order: 1
            },
            {
              label: 'Calories',
              data: values,
              backgroundColor: '#6366f1',
              borderRadius: 6,
              barThickness: 35, 
              order: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { display: false }, ticks: { font: { weight: 'bold' } } },
            y: { grid: { borderDash: [4, 4], color: '#f1f5f9' }, beginAtZero: true }
          }
        }
      });
      
      setTimeout(() => {
          const container = document.getElementById('scrollContainer');
          container.scrollLeft = container.scrollWidth;
      }, 100);
    }

    function renderWeightChart(weightData) {
      const ctx = document.getElementById('weightChart').getContext('2d');
      if (weightChartInstance) weightChartInstance.destroy();

      const points = weightData.map(w => {
         let dateStr = "";
         if (w.x.includes('/')) {
             const p = w.x.split('/');
             const year = p[2];
             const month = p[0].padStart(2, '0');
             const day = p[1].padStart(2, '0');
             dateStr = `${year}-${month}-${day}`;
         } else {
             dateStr = w.x; 
         }
         return { x: dateStr, y: w.y };
      }).sort((a, b) => new Date(a.x) - new Date(b.x));

      weightChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [{
            label: 'Weight',
            data: points,
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            borderWidth: 3,
            pointRadius: 6, 
            pointBackgroundColor: '#fff',
            pointBorderColor: '#10b981',
            fill: true,
            tension: 0.2,
            spanGaps: true 
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { 
              type: 'time', 
              time: { unit: 'day', tooltipFormat: 'MMM d' },
              grid: { display: false } 
            },
            y: { 
              grid: { color: '#f1f5f9' },
              suggestedMin: (ctx) => {
                 if(points.length === 0) return 0;
                 return Math.min(...points.map(p => p.y)) - 5;
              },
              suggestedMax: (ctx) => {
                 if(points.length === 0) return 200;
                 return Math.max(...points.map(p => p.y)) + 5;
              }
            }
          }
        }
      });
    }

    async function deleteLog(id) {
      if(!confirm("Delete this entry?")) return;
      await fetch(`/api/log/${id}`, { method: 'DELETE', headers: { "Content-Type": "application/json" }, body: JSON.stringify({ user: currentUser }) });
      loadStats();
    }

    async function submitManual() {
      const cat = document.getElementById('mCategory').value;
      const cals = document.getElementById('mCals').value;
      const prot = document.getElementById('mProt').value;
      const date = document.getElementById('mDate').value;
      const item = "Manual " + cat;
      await fetch("/api/log/manual", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ user: currentUser, item, calories: cals, protein: prot, category: cat, date: date }) });
      document.getElementById('mCals').value = ""; document.getElementById('mProt').value = ""; 
      const tz = currentUser === 'husband' ? 'Pacific/Honolulu' : 'Asia/Tokyo';
      updateDatePicker(tz);
      loadStats(); setMode('photo');
    }

    async function submitWeight() {
      const w = document.getElementById('newWeight').value;
      const d = document.getElementById('weightDate').value;
      if(!w) return;
      await fetch("/api/weight", { 
          method: "POST", 
          headers: { "Content-Type": "application/json" }, 
          body: JSON.stringify({ user: currentUser, weight: w, date: d }) 
      });
      toggleWeight(); loadStats();
    }

    async function uploadPhoto() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) return;
      const btn = document.getElementById('photoBtn');
      const status = document.getElementById('status');
      btn.innerText = "Analyzing..."; status.innerText = "‚è≥ Sending to AI...";
      const resizedBlob = await shrinkImage(file);
      
      const formData = new FormData(); 
      formData.append("image", resizedBlob); 
      formData.append("user", currentUser);
      
      const correctDate = getTodayForUser();
      formData.append("date", correctDate); 

      try {
        const res = await fetch("/api/log/photo", { method: "POST", body: formData });
        const data = await res.json();
        if(data.error) throw new Error(data.error);
        status.innerText = "‚úÖ Added!"; loadStats();
      } catch (e) { status.innerText = "‚ùå " + e.message; }
      finally { btn.innerText = "Take Photo"; document.getElementById('fileInput').value = ""; }
    }

    function shrinkImage(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const MAX_WIDTH = 800;
            const scaleSize = MAX_WIDTH / img.width;
            canvas.width = MAX_WIDTH;
            canvas.height = img.height * scaleSize;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            canvas.toBlob(resolve, 'image/jpeg', 0.7);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>
