<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>CalorieHUD 2.0</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <style>
    :root { --primary: #6366f1; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; }
    body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
    .tabs { display: flex; gap: 8px; background: #e0e7ff; padding: 4px; border-radius: 12px; margin-bottom: 20px; }
    .tab { flex: 1; text-align: center; padding: 10px; border-radius: 10px; font-weight: 600; cursor: pointer; }
    .tab.active { background: white; color: #1e1b4b; }
    .card { background: var(--card); padding: 15px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .chart-wrapper { background: white; padding: 20px; border-radius: 24px; margin-bottom: 20px; }
    .scroll-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .wide-chart-body { height: 250px; width: 1200px; }
    .weight-chart-body { height: 200px; }
    .hidden { display: none; }
    .day-group { margin-bottom: 15px; border: 1px solid #f1f5f9; border-radius: 12px; overflow: hidden; }
    .day-header { background: #f8fafc; padding: 8px 12px; font-weight: 700; display: flex; justify-content: space-between; }
    .history-item { display: flex; justify-content: space-between; padding: 10px 12px; border-top: 1px solid #f1f5f9; }
  </style>
</head>
<body onload="init()">
  <div class="tabs">
    <div id="tabHusband" class="tab active" onclick="setUser('husband')">ðŸ‡ºðŸ‡¸ Husband</div>
    <div id="tabWife" class="tab" onclick="setUser('wife')">ðŸ‡¯ðŸ‡µ Wife</div>
  </div>

  <div class="card">
    <div style="font-size: 11px; font-weight: 700; color: #64748b;">TODAY'S CALORIES</div>
    <div style="font-size: 32px; font-weight: 800; color: var(--primary);" id="consumedDisplay">0</div>
  </div>

  <div class="chart-wrapper">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px">
      <span style="font-weight:700">Calorie History</span>
      <select id="viewSelector" onchange="loadStats()" style="font-size:12px">
        <option value="rolling">Last 30 Days</option>
        <option value="0">January</option>
      </select>
    </div>
    <div class="scroll-wrapper" id="scrollContainer">
      <div class="wide-chart-body"><canvas id="calChart"></canvas></div>
    </div>
  </div>

  <div class="chart-wrapper">
    <div style="font-weight:700; margin-bottom:10px">Weight Trend</div>
    <div class="weight-chart-body"><canvas id="weightChart"></canvas></div>
  </div>

  <div id="historyList"></div>

  <script>
    let currentUser = 'husband';
    let weightChartInstance = null;
    let calChartInstance = null;

    function init() { loadStats(); }

    function setUser(user) {
      currentUser = user;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById(user === 'husband' ? 'tabHusband' : 'tabWife').classList.add('active');
      loadStats();
    }

    async function loadStats() {
      const res = await fetch(`/api/stats?user=${currentUser}`);
      const data = await res.json();
      document.getElementById('consumedDisplay').innerText = data.totalCals;
      renderHistory(data.recentLogs);
      renderCharts(data);
    }

    function renderCharts(data) {
      const viewMode = document.getElementById('viewSelector').value;
      const labels = [];
      const calValues = [];
      
      let start = new Date();
      if(viewMode === 'rolling') { start.setDate(start.getDate() - 29); } 
      else { start = new Date(2026, 0, 1); }

      for(let i=0; i < 31; i++) {
        const d = new Date(start);
        d.setDate(d.getDate() + i);
        if(viewMode !== 'rolling' && d.getMonth() !== 0) break;
        const l = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        labels.push(l);
        const cIdx = data.chartData.labels.indexOf(l);
        calValues.push(cIdx > -1 ? data.chartData.values[cIdx] : 0);
      }

      // CALORIE CHART
      const ctxCal = document.getElementById('calChart').getContext('2d');
      if(calChartInstance) calChartInstance.destroy();
      calChartInstance = new Chart(ctxCal, {
        type: 'bar',
        data: { labels, datasets: [{ data: calValues, backgroundColor: '#6366f1', borderRadius: 5 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
      });

      // WEIGHT CHART - FORCED MATCHING
      const weightData = (data.weightHistory || []).map(w => {
        // Strip everything except the date part (MM/DD/YYYY)
        const cleanDate = w.x.split(' ')[0]; 
        return { x: cleanDate, y: parseFloat(w.y) };
      }).sort((a,b) => new Date(a.x) - new Date(b.x));

      const ctxW = document.getElementById('weightChart').getContext('2d');
      if(weightChartInstance) weightChartInstance.destroy();
      weightChartInstance = new Chart(ctxW, {
        type: 'line',
        data: {
          datasets: [{
            data: weightData,
            borderColor: '#10b981',
            tension: 0.3,
            pointRadius: 4,
            spanGaps: true
          }]
        },
        options: { 
          responsive: true, 
          maintainAspectRatio: false,
          scales: { 
            x: { type: 'time', time: { unit: 'day' } },
            y: { beginAtZero: false } 
          },
          plugins: { legend: { display: false } }
        }
      });
      document.getElementById('scrollContainer').scrollLeft = 9999;
    }

    function renderHistory(logs) {
      const groups = {};
      logs.forEach(l => {
        const d = new Date(l.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        if(!groups[d]) groups[d] = { total: 0, items: [] };
        groups[d].items.push(l); groups[d].total += parseInt(l.calories || 0);
      });
      document.getElementById('historyList').innerHTML = Object.keys(groups).map(k => `
        <div class="day-group">
          <div class="day-header"><span>${k}</span><span>${groups[k].total} cals</span></div>
          ${groups[k].items.map(i => `<div class="history-item"><span>${i.item}</span><span>${i.calories}</span></div>`).join('')}
        </div>
      `).join('');
    }
  </script>
</body>
</html>
